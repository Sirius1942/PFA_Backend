{% extends "base.html" %}

{% block content %}
<div class="stocks-container">
    <!-- 搜索和过滤栏 -->
    <div class="search-bar">
        <div class="search-input-group">
            <input type="text" id="stockSearchInput" placeholder="输入股票代码或名称搜索...">
            <button class="search-btn" onclick="searchStocks()">
                <i class="fas fa-search"></i>
            </button>
        </div>
        
        <div class="filter-group">
            <select id="marketFilter">
                <option value="">全部市场</option>
                <option value="SH">上海市场</option>
                <option value="SZ">深圳市场</option>
                <option value="BJ">北京市场</option>
            </select>
            
            <select id="industryFilter">
                <option value="">全部行业</option>
                <option value="technology">科技</option>
                <option value="finance">金融</option>
                <option value="healthcare">医疗</option>
                <option value="energy">能源</option>
                <option value="consumer">消费</option>
            </select>
            
            <button class="filter-btn" onclick="applyFilters()">
                <i class="fas fa-filter"></i> 应用筛选
            </button>
        </div>
    </div>

    <!-- 主要内容区域 -->
    <div class="stocks-main">
        <!-- 左侧：股票列表 -->
        <div class="stocks-list-panel">
            <div class="panel-header">
                <h3>股票列表</h3>
                <div class="view-controls">
                    <button class="view-btn active" data-view="list">
                        <i class="fas fa-list"></i>
                    </button>
                    <button class="view-btn" data-view="grid">
                        <i class="fas fa-th"></i>
                    </button>
                </div>
            </div>
            
            <div class="stocks-list" id="stocksList">
                <!-- 示例股票数据 -->
                <div class="stock-item" onclick="selectStock('000001', '平安银行')">
                    <div class="stock-info">
                        <div class="stock-code">000001</div>
                        <div class="stock-name">平安银行</div>
                    </div>
                    <div class="stock-price">
                        <div class="current-price">¥12.34</div>
                        <div class="price-change positive">+0.26 (+2.15%)</div>
                    </div>
                    <div class="stock-indicators">
                        <span class="indicator bullish">看涨</span>
                        <span class="volume">Vol: 1.2M</span>
                    </div>
                </div>
                
                <div class="stock-item" onclick="selectStock('000858', '五粮液')">
                    <div class="stock-info">
                        <div class="stock-code">000858</div>
                        <div class="stock-name">五粮液</div>
                    </div>
                    <div class="stock-price">
                        <div class="current-price">¥185.67</div>
                        <div class="price-change negative">-2.83 (-1.50%)</div>
                    </div>
                    <div class="stock-indicators">
                        <span class="indicator bearish">看跌</span>
                        <span class="volume">Vol: 856K</span>
                    </div>
                </div>
                
                <div class="stock-item" onclick="selectStock('000002', '万科A')">
                    <div class="stock-info">
                        <div class="stock-code">000002</div>
                        <div class="stock-name">万科A</div>
                    </div>
                    <div class="stock-price">
                        <div class="current-price">¥18.92</div>
                        <div class="price-change positive">+0.15 (+0.80%)</div>
                    </div>
                    <div class="stock-indicators">
                        <span class="indicator neutral">观望</span>
                        <span class="volume">Vol: 2.1M</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧：股票详情和分析 -->
        <div class="stock-analysis-panel">
            <div class="analysis-header">
                <div class="selected-stock-info" id="selectedStockInfo">
                    <h2>选择一只股票进行分析</h2>
                    <p>从左侧列表中选择股票查看详细分析</p>
                </div>
                <div class="analysis-actions" id="analysisActions" style="display: none;">
                    <button class="btn-primary" onclick="startAnalysis()">
                        <i class="fas fa-chart-line"></i> 开始分析
                    </button>
                    <button class="btn-secondary" onclick="addToWatchlist()">
                        <i class="fas fa-star"></i> 加入自选
                    </button>
                </div>
            </div>

            <!-- 分析结果区域 -->
            <div class="analysis-content" id="analysisContent" style="display: none;">
                <!-- K线图 -->
                <div class="chart-section">
                    <div class="section-header">
                        <h3>K线走势</h3>
                        <div class="chart-controls">
                            <button class="time-btn active" data-period="1d">日K</button>
                            <button class="time-btn" data-period="1w">周K</button>
                            <button class="time-btn" data-period="1m">月K</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="stockChart" width="800" height="400"></canvas>
                    </div>
                </div>

                <!-- 技术指标 -->
                <div class="indicators-section">
                    <h3>技术指标</h3>
                    <div class="indicators-grid">
                        <div class="indicator-card">
                            <div class="indicator-name">RSI</div>
                            <div class="indicator-value">65.2</div>
                            <div class="indicator-status neutral">中性</div>
                        </div>
                        <div class="indicator-card">
                            <div class="indicator-name">MACD</div>
                            <div class="indicator-value">0.15</div>
                            <div class="indicator-status bullish">看涨</div>
                        </div>
                        <div class="indicator-card">
                            <div class="indicator-name">KDJ</div>
                            <div class="indicator-value">72.8</div>
                            <div class="indicator-status bearish">超买</div>
                        </div>
                        <div class="indicator-card">
                            <div class="indicator-name">MA20</div>
                            <div class="indicator-value">12.89</div>
                            <div class="indicator-status bullish">支撑</div>
                        </div>
                    </div>
                </div>

                <!-- AI分析结果 -->
                <div class="ai-analysis-section">
                    <h3><i class="fas fa-robot"></i> AI智能分析</h3>
                    <div class="analysis-result" id="aiAnalysisResult">
                        <div class="analysis-loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>AI正在分析中...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedStock = null;
let stockChart = null;

document.addEventListener('DOMContentLoaded', function() {
    // 初始化视图控制
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const view = this.dataset.view;
            const stocksList = document.getElementById('stocksList');
            stocksList.className = `stocks-list ${view}-view`;
        });
    });
    
    // 初始化时间周期控制
    document.querySelectorAll('.time-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            if (selectedStock) {
                updateChart(this.dataset.period);
            }
        });
    });
    
    loadStocksList();
});

function selectStock(code, name) {
    selectedStock = { code, name };
    
    // 更新选中股票信息
    const selectedStockInfo = document.getElementById('selectedStockInfo');
    selectedStockInfo.innerHTML = `
        <div class="selected-stock-details">
            <h2>${code} ${name}</h2>
            <div class="stock-stats">
                <span class="current-price">¥12.34</span>
                <span class="change positive">+0.26 (+2.15%)</span>
            </div>
        </div>
    `;
    
    // 显示分析按钮
    document.getElementById('analysisActions').style.display = 'flex';
    
    // 高亮选中的股票
    document.querySelectorAll('.stock-item').forEach(item => {
        item.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
}

async function startAnalysis() {
    if (!selectedStock) return;
    
    // 显示分析内容区域
    document.getElementById('analysisContent').style.display = 'block';
    
    // 初始化图表
    initStockChart();
    
    // 开始AI分析
    await performAIAnalysis();
}

function initStockChart() {
    const ctx = document.getElementById('stockChart').getContext('2d');
    
    // 模拟K线数据
    const data = {
        labels: ['09:30', '10:00', '10:30', '11:00', '11:30', '13:00', '13:30', '14:00', '14:30', '15:00'],
        datasets: [{
            label: '股价',
            data: [12.08, 12.15, 12.22, 12.18, 12.25, 12.30, 12.28, 12.34, 12.31, 12.34],
            borderColor: '#dc2626',
            backgroundColor: 'rgba(220, 38, 38, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.1
        }]
    };
    
    if (stockChart) {
        stockChart.destroy();
    }
    
    stockChart = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return '¥' + value.toFixed(2);
                        }
                    }
                }
            }
        }
    });
}

async function performAIAnalysis() {
    const analysisResult = document.getElementById('aiAnalysisResult');
    
    try {
        const response = await apiRequest('/api/v1/assistant/analyze-stock', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
            },
            body: JSON.stringify({
                stock_code: selectedStock.code,
                analysis_type: 'comprehensive',
                period: '1d',
                days: 30
            })
        });
        
        analysisResult.innerHTML = `
            <div class="analysis-summary">
                <h4>分析摘要</h4>
                <p>${response.summary || '基于技术面和基本面分析，该股票表现良好，建议关注。'}</p>
            </div>
            
            <div class="analysis-recommendations">
                <h4>投资建议</h4>
                <div class="recommendation-tags">
                    <span class="rec-tag buy">建议买入</span>
                    <span class="rec-tag hold">风险可控</span>
                </div>
            </div>
            
            <div class="analysis-details">
                <h4>详细分析</h4>
                <ul>
                    <li>技术面：股价处于上升通道，成交量放大</li>
                    <li>基本面：公司业绩稳定增长，估值合理</li>
                    <li>资金面：主力资金呈净流入状态</li>
                    <li>风险提示：需关注市场整体走势影响</li>
                </ul>
            </div>
        `;
        
    } catch (error) {
        console.error('Analysis error:', error);
        analysisResult.innerHTML = `
            <div class="analysis-error">
                <i class="fas fa-exclamation-triangle"></i>
                <p>分析失败，请重试</p>
                <button class="btn-secondary" onclick="performAIAnalysis()">重新分析</button>
            </div>
        `;
    }
}

function updateChart(period) {
    if (stockChart) {
        // 这里可以根据周期更新图表数据
        showNotification(`已切换到${period}视图`, 'info');
    }
}

function addToWatchlist() {
    if (selectedStock) {
        showNotification(`${selectedStock.name} 已加入自选股`, 'success');
    }
}

function searchStocks() {
    const query = document.getElementById('stockSearchInput').value.trim();
    if (query) {
        showNotification(`搜索: ${query}`, 'info');
        // 这里可以调用搜索API
    }
}

function applyFilters() {
    const market = document.getElementById('marketFilter').value;
    const industry = document.getElementById('industryFilter').value;
    
    showNotification('筛选条件已应用', 'success');
    // 这里可以调用过滤API
}

function loadStocksList() {
    // 这里可以从API加载股票列表
    console.log('Loading stocks list...');
}
</script>
{% endblock %}
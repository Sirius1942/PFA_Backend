{% extends "modern_base.html" %}

{% block page_title %}仪表板{% endblock %}
{% block page_description %}投资概览与实时市场数据{% endblock %}

{% block content %}
<div id="dashboardApp" class="space-y-6">
    <!-- 欢迎卡片 -->
    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold">欢迎回来，{{ user.username }}！</h2>
                <p class="text-blue-100">今天是个投资的好日子</p>
            </div>
            <div class="text-right">
                <p class="text-blue-100 text-sm">最后登录</p>
                <p class="text-white font-medium">{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else '首次登录' }}</p>
            </div>
        </div>
    </div>

    <!-- 加载状态和错误提示 -->
    <div v-if="loading" class="bg-white rounded-lg shadow p-6 text-center">
        <div class="flex items-center justify-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            <span class="ml-3 text-gray-600">正在加载看板数据...</span>
        </div>
    </div>

    <div v-if="error" class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
        <div class="flex items-center justify-center">
            <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
            <span class="text-red-700">{{ error }}</span>
            <button @click="refreshData" class="ml-4 px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors">
                重试
            </button>
        </div>
    </div>

    <!-- 统计卡片 -->
    <div v-if="!loading" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-green-100 rounded-md flex items-center justify-center">
                        <i class="fas fa-chart-line text-green-600"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">市场概况</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ dashboardData?.market_summary?.total_stocks || 0 }}支股票</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-blue-100 rounded-md flex items-center justify-center">
                        <i class="fas fa-star text-blue-600"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">我的自选</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ watchlist?.length || 0 }}支股票</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-yellow-100 rounded-md flex items-center justify-center">
                        <i class="fas fa-arrow-up text-yellow-600"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">今日盈亏</p>
                    <p class="text-2xl font-semibold" :class="totalChangeAmount >= 0 ? 'text-green-600' : 'text-red-600'">
                        {{ totalChangeAmount >= 0 ? '+' : '' }}{{ totalChangeAmount.toFixed(2) }}
                    </p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-purple-100 rounded-md flex items-center justify-center">
                        <i class="fas fa-robot text-purple-600"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">AI建议</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ dashboardData?.market_summary?.up_count || 0 }}条建议</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 主要内容区域 -->
    <div v-if="!loading" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- 投资组合图表 -->
        <div class="lg:col-span-2 bg-white rounded-lg shadow">
            <div class="p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">投资组合表现</h3>
                <div class="h-64">
                    <canvas id="portfolioChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 快速操作 -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">快速操作</h3>
                <div class="space-y-3">
                    <button @click="goToChat" class="w-full flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                        <i class="fas fa-robot mr-2"></i>
                        AI助手咨询
                    </button>
                    <button @click="goToStocks" class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                        <i class="fas fa-chart-bar mr-2"></i>
                        股票分析
                    </button>
                    <button @click="goToMarket" class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                        <i class="fas fa-globe mr-2"></i>
                        市场洞察
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 关注股票列表 -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">关注股票</h3>
                <button class="text-blue-600 hover:text-blue-800 text-sm font-medium">查看全部</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">股票</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">当前价格</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">涨跌</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">涨跌幅</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr v-for="stock in watchlist" :key="stock.stock_code">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="text-sm font-medium text-gray-900">{{ stock.stock_name }}</div>
                                    <div class="text-sm text-gray-500 ml-2">{{ stock.stock_code }}</div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥{{ stock.current_price?.toFixed(2) }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm" :class="stock.change_amount >= 0 ? 'text-green-600' : 'text-red-600'">
                                {{ stock.change_amount >= 0 ? '+' : '' }}{{ stock.change_amount?.toFixed(2) }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm" :class="stock.change_percent >= 0 ? 'text-green-600' : 'text-red-600'">
                                {{ stock.change_percent >= 0 ? '+' : '' }}{{ stock.change_percent?.toFixed(2) }}%
                            </td>
                        </tr>
                        <tr v-if="!loading && watchlist.length === 0">
                            <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                                <div class="flex flex-col items-center">
                                    <i class="fas fa-star text-gray-300 text-3xl mb-2"></i>
                                    <p class="text-sm">暂无自选股票</p>
                                    <button @click="goToStocks" class="mt-2 text-blue-600 hover:text-blue-800 text-sm">
                                        去添加股票
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            watchlist: [],
            dashboardData: null,
            loading: true,
            error: null
        }
    },
    computed: {
        totalChangeAmount() {
            if (!this.watchlist || this.watchlist.length === 0) return 0;
            return this.watchlist.reduce((total, stock) => total + stock.change_amount, 0);
        }
    },
    async mounted() {
        await this.loadDashboardData();
    },
    methods: {
        async loadDashboardData() {
            try {
                this.loading = true;
                this.error = null;
                
                // 调用个性化看板API
                const response = await axios.get('/api/v1/stocks/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${this.getAccessToken()}`
                    }
                });
                
                this.dashboardData = response.data;
                this.watchlist = response.data.watchlist_stocks || [];
                
            } catch (error) {
                console.error('加载看板数据失败:', error);
                this.error = '加载数据失败，请刷新页面重试';
                
                // 如果是认证错误，跳转到登录页
                if (error.response?.status === 401) {
                    window.location.href = '/login';
                }
            } finally {
                this.loading = false;
            }
        },
        
        getAccessToken() {
            // 从cookie或localStorage获取token
            const cookieToken = document.cookie
                .split('; ')
                .find(row => row.startsWith('access_token='))
                ?.split('=')[1];
            
            return cookieToken || localStorage.getItem('access_token') || '';
        },
        
        async refreshData() {
            await this.loadDashboardData();
        },
        
        goToChat() {
            window.location.href = '/chat';
        },
        goToStocks() {
            window.location.href = '/stocks';
        },
        goToMarket() {
            window.location.href = '/market';
        },
        initChart() {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                    datasets: [{
                        label: '投资组合价值',
                        data: [100000, 105000, 108000, 103000, 115000, 125430],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
    },
    mounted() {
        this.initChart();
    }
}).mount('#dashboardApp');
</script>
{% endblock %}